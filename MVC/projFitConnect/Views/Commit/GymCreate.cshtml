@{
    ViewData["Title"] = "GymCreate";
}

<div style="padding-top:120px;"></div>
<h1>新增場館</h1>

<form method="post" action="https://localhost:7199/api/GymList" class="needs-validation" enctype="multipart/form-data" id="gymform" novalidate>
    <div class="row needs-validation" novalidate>
        <div class="col-md-6">
            <div class="mb-3">
                <h3>請輸入負責人名</h3>
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">負責人姓名</span>
                    <input type="text" class="form-control" id="InputOwner" placeholder="例:王曉明" aria-label="負責人姓名" aria-describedby="basic-addon1" name="Owner" required>
                    <div class="invalid-feedback">
                        請輸入負責人名
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <h3>請輸入公司名</h3>
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">公司名</span>
                    <input type="text" class="form-control" id="Name" placeholder="例:FitConnect" aria-label="公司名" aria-describedby="basic-addon1" name="Name" required>
                    <div class="invalid-feedback">
                        請輸入公司名
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <h3>請輸入電話</h3>
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">電話</span>
                    <input type="text" class="form-control" id="GymPhone" placeholder="例:0212345678" aria-label="電話" aria-describedby="basic-addon1" name="GymPhone" required>
                    <div class="invalid-feedback">
                        請輸入電話
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <h3>上傳場館照片</h3>
                <input class="form-control form-control-sm" id="GymPhoto" type="file" name="UploadedGymPhoto" onchange="previewImage(event)" required>
                <div class="invalid-feedback">請上傳場館照片</div>
            </div>
            <div class="mb-3">
                <h3>照片預覽</h3>
                <img src="" class="img-fluid rounded-start" />
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <h3>請輸入場館名</h3>
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">場館名</span>
                    <input type="text" class="form-control" id="GymName" placeholder="例:大安館" aria-label="場館名" aria-describedby="basic-addon1" name="GymName" required>
                    <div class="invalid-feedback">
                        請輸入場館名
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <h3>營業時間</h3>
                <div class="input-group mb-3">
                    <h3>開始時間</h3>
                    <select class="form-select" aria-label="Default select example" id="start_time" name="start_time" required>
                        <option selected disabled>開始時間</option>
                    </select>
                    <div class="invalid-feedback">
                        請選擇開始時間
                    </div>
                    <h3>結束時間</h3>
                    <select class="form-select" aria-label="Default select example" id="end_time" name="end_time" required>
                        <option selected disabled>結束時間</option>
                    </select>
                    <div class="invalid-feedback">
                        請選擇結束時間
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="input-group mb-3">
                    <h3>縣市</h3>
                    <select class="form-select" aria-label="Default select example" id="citys" name="city" required>
                    </select>
                    <div class="invalid-feedback">
                        請選擇縣市
                    </div>
                    <h3>地區</h3>
                    <select class="form-select" aria-label="Default select example" id="regions" name="GymRegion" required>
                    </select>
                    <div class="invalid-feedback">
                        請選擇地區
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <h3>請輸入地址</h3>
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">地址</span>
                    <input type="text" class="form-control" id="GymAddress" placeholder="例:台北市大安區辛亥路三段55號" aria-label="地址" aria-describedby="basic-addon1" name="GymAddress" required>
                </div>
            </div>

            <div class="mb-3">
                <h3>請輸入停車場資訊</h3>
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">停車場</span>
                    <input type="text" class="form-control" id="GymPark" placeholder="例:大安國民運動中心停車場" aria-label="停車場" aria-describedby="basic-addon1" name="GymPark">
                </div>
            </div>

            <div class="mb-3">
                <h3>請輸入交通資訊</h3>
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">交通</span>
                    <input type="text" class="form-control" id="GymTraffic" placeholder="例:捷運大安站" aria-label="交通" aria-describedby="basic-addon1" name="GymTraffic">
                </div>
            </div>
            <h3>場地簡介</h3>
            <div class="input-group">
                <span class="input-group-text">場地簡介</span>
                <textarea class="form-control" id="GymDescribe" placeholder="例:本場館設有:游泳池" aria-label="GymDescribe" name="GymDescribe" required></textarea>
                <div class="invalid-feedback">
                    請輸入場館簡介
                </div>
            </div>
            <br />
            <div class="mb-2">
                <button type="submit" class="btn btn-primary" id="btnsubmit">送出</button>
                <a href="https://localhost:7168/Home" class="btn btn-outline-secondary">取消</a>
                <button type="button" class="btn btn-info" id="btnDemo">Demo</button>
            </div>
        </div>
    </div>
</form>
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            const start = document.getElementById('start_time');
            const end = document.getElementById('end_time');

            // 讀取時間選項
            async function loadData() {
                try {
                    const response = await fetch('https://localhost:7199/api/GymList/time');
                    const data = await response.json();

                    let timeOptions = data.map(item => `<option value="${item.timeName.substring(0, 5)}">${item.timeName.substring(0, 5)}</option>`).join('');

                    start.innerHTML = '<option value="">開始時間</option>' + timeOptions;
                    end.innerHTML = '<option value="">結束時間</option>' + timeOptions;
                    // 讀取select事件
                    start.addEventListener('change', handleTimeChange);
                    end.addEventListener('change', handleTimeChange);
                } catch (error) {
                    console.error("Error loading time data:", error);
                }
            };
            // 如果開始時間超過結束時間，把結束時間改成開始時間
            async function handleTimeChange() {
                const startTime = parseInt(start.value);
                const endTime = parseInt(end.value);

                if (startTime > endTime) {
                    end.value = start.value;
                }
            };

            // 新增陣列用來記錄縣市地區資料
            let allData = [];
            // 新增陣列用來記錄 regionid
            let regionIdMap = {};
            // 載入縣市
            async function loadCities() {
                const citySelect = document.getElementById('citys');
                try {
                    const response = await fetch("https://localhost:7199/api/Region");
                    allData = await response.json();// 將數據存儲在全局變量中

                    const uniqueCities = new Set();
                    allData.forEach(item => {
                        if (!uniqueCities.has(item.city)) {
                            uniqueCities.add(item.city);
                            const option = document.createElement('option');
                            option.value = item.city;
                            option.textContent = item.city;
                            citySelect.appendChild(option);
                        }
                    });
                } catch (error) {
                    console.error("Error fetching cities data:", error);
                }
                loadRegions();
            };
            // 載入地區
            async function loadRegions() {
                const regions = document.getElementById('regions');
                const citySelect = document.getElementById('citys');
                const selectedCity = citySelect.value;
                //const selectedRegion = regions.value;

                let regionOptions = '';
                const filteredRegions = allData.filter(item => item.city === selectedCity);

                regionIdMap = {};
                filteredRegions.forEach(item => {
                    regionOptions += `<option value="${item.region}">${item.region}</option>`;
                    regionIdMap[item.region] = item.regionId;
                });
                regions.innerHTML = regionOptions;
            };

            // Demo按鈕的功能
            document.getElementById('btnDemo').addEventListener('click', async () => {
                document.getElementById('InputOwner').value = "王曉明";
                document.getElementById('Name').value = "Fit2";
                document.getElementById('GymPhone').value = "0212345678";
                document.getElementById('GymName').value = "大安二館";
                document.getElementById('start_time').value = "09:00";
                document.getElementById('end_time').value = "22:00";
                document.getElementById('GymAddress').value = "台北市大安區復興南路一段";
                document.getElementById('GymPark').value = "大安國民運動中心停車場";
                document.getElementById('GymTraffic').value = "226公車";
                document.getElementById('GymDescribe').value = "本場館設有:多功能教室";

                // 模擬選擇縣市和地區
                document.getElementById('citys').value = "台北市";
                await loadRegions();  // 確保地區選項正確更新
                document.getElementById('regions').value = "大安區";

                // 為了讓表單驗證正確通過，手動觸發change事件
                document.getElementById('InputOwner').dispatchEvent(new Event('change'));
                document.getElementById('Name').dispatchEvent(new Event('change'));
                document.getElementById('GymPhone').dispatchEvent(new Event('change'));
                document.getElementById('GymName').dispatchEvent(new Event('change'));
                document.getElementById('start_time').dispatchEvent(new Event('change'));
                document.getElementById('end_time').dispatchEvent(new Event('change'));
                document.getElementById('GymAddress').dispatchEvent(new Event('change'));
                document.getElementById('GymDescribe').dispatchEvent(new Event('change'));
            });

            async function init() {
                await loadData();
                await loadCities();

                const citySelect = document.getElementById('citys');
                citySelect.addEventListener('change', async () => {
                    await loadRegions();
                    const selectedRegion = document.getElementById('regions').value;
                    console.log(selectedRegion);  // 確保選擇的地區被正確印出
                    const regionId = regionIdMap[selectedRegion];
                    console.log(regionId);  // 如果需要，可以印出對應的 regionId
                });
            }

            init();
        });
        //照片預覽
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.querySelector('.img-fluid');
            const reader = new FileReader();

            reader.onload = function () {
                preview.src = reader.result;
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "";
            }
        }
        //表單回傳API
        const gymform = document.getElementById('gymform');
        gymform.addEventListener('submit', async function (event) {
            event.preventDefault();
            const response = await fetch('https://localhost:7199/api/GymList',
                {
                    method: 'POST',
                    body: new FormData(gymform)
                });
            const data = await response.json();
            console.log(data);
            if (data.success) {
                window.location.href = '@Url.Content("~/home")';
                alert('申請成功');
            }
            console.log(data);
        });
        //資料檢查
        (() => {
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            const forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }

                    form.classList.add('was-validated')
                }, false)
            })
        })()
    </script>
}
