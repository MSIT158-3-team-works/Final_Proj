@{
    ViewData["Title"] = "FieldReviewList";
}

@section Styles {
    <style>
        thead {
            background-color: #101F41;
        }

        .head {
            color: #D0D0D0 !important;
        }
    </style>
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<div>
    <h2>場地清單</h2>
    <table class="table table-striped table-hover m-2 text-center">
        <thead>
            <tr>
                <th class="head" scope="col">No.</th>
                <th class="head" scope="col">場地狀態</th>
                <th class="head" scope="col">場館</th>
                <th class="head" scope="col">場地</th>
                <th class="head" scope="col">樓層</th>
                <th class="head" scope="col">費用</th>
                <th class="head" scope="col">更新</th>
                <th class="head" scope="col">狀態</th>
                <th class="head" scope="col">審核</th>
                <th class="head" scope="col">刪除</th>
            </tr>
        </thead>
        <tbody id="fieldList">
            <!-- 場地清單 -->
        </tbody>
    </table>
</div>

<!-- 刪除確認視窗 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">確認刪除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                確定要刪除這個場地嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">確認刪除</button>
            </div>
        </div>
    </div>
</div>
<!-- 狀態更改確認視窗 -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">確認更改狀態</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                確定要更改這個場地的審核狀態嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" id="confirmStatusBtn" class="btn btn-warning">確認更改</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch(`https://localhost:7199/api/AdminFieldlist/`);
                const data = await response.json();
                console.log(data)
                // 場地清單
                const tableBody = document.querySelector('table tbody');
                tableBody.innerHTML = data.map((item, index) => `
                                                    <tr>
                                                        <td>${index + 1}</td>
                                                        <td>${item.status ? '審核完成' : '審核中'}</td>
                                                        <td>${item.gymName}</td>
                                                        <td>${item.fieldName}</td>
                                                        <td>${item.floor}</td>
                                                        <td>${item.fieldPayment}</td>
                                                        <td>
                                                            <button class="btn btn-outline-success update-btn" data-id="${item.fieldId}">修改</button>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-outline-primary view-btn" data-id="${item.fieldId}">檢視</button>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-outline-warning confirm-btn" data-id="${item.fieldId}" data-status="${item.status}" data-bs-toggle="modal" data-bs-target="#statusModal">更改</button>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-outline-danger delete-btn" data-id="${item.fieldId}" data-bs-toggle="modal" data-bs-target="#deleteModal">刪除</button>
                                                        </td>
                                                    </tr>
                                                `).join('');
                //表單按鈕事件
                tableBody.addEventListener('click', async (event) => {
                    const target = event.target;
                    const fieldId = target.getAttribute('data-id');

                    if (target.classList.contains('confirm-btn')) {
                        const statusBtn = document.getElementById('confirmStatusBtn');
                        statusBtn.setAttribute('data-id', fieldId);
                        const status = target.getAttribute('data-status') === 'true';
                        statusBtn.setAttribute('data-new-status', !status);
                    }

                    if (target.classList.contains('view-btn')) {
                        window.location.href = `https://localhost:7168/admin/fieldreview?id=${fieldId}`;
                    }
                    if (target.classList.contains('update-btn')) {
                        window.location.href = `https://localhost:7168/admin/fieldupdate?id=${fieldId}`;
                    }
                });
                //方法，刪除按鈕按下時，將field-id傳給confirmDeleteBtn的data-id屬性
                document.querySelectorAll('.delete-btn').forEach(item => {
                    item.addEventListener('click', function (event) {
                        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
                        confirmDeleteBtn.setAttribute('data-id', item.getAttribute('data-id'));
                    })

                });
                //刪除場地
                document.getElementById('confirmDeleteBtn').addEventListener('click', async (event) => {
                    const fieldId = event.target.getAttribute('data-id');
                    try {
                        const deleteResponse = await fetch(`https://localhost:7199/api/AdminFieldList/${fieldId}`, {
                            method: 'DELETE'
                        });

                        if (deleteResponse.ok) {
                            location.reload();
                        } else {
                            console.error('刪除失敗:', deleteResponse.status);
                        }
                    } catch (error) {
                        console.error('刪除請求失敗:', error);
                    } finally {
                        $('#deleteModal').modal('hide');
                    }
                });
                //更新場地審核狀態
                document.getElementById('confirmStatusBtn').addEventListener('click', async (event) => {
                    const fieldId = event.target.getAttribute('data-id');
                    const newStatus = event.target.getAttribute('data-new-status') === 'true';

                    try {
                        const confirmResponse = await fetch(`https://localhost:7199/api/AdminFieldlist/${fieldId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: newStatus })
                        });

                        if (confirmResponse.ok) {
                            location.reload();
                        } else {
                            console.error('狀態更新失敗:', confirmResponse.status);
                        }
                    } catch (error) {
                        console.error('狀態更新請求失敗:', error);
                    } finally {
                        $('#statusModal').modal('hide');
                    }
                });

            } catch (error) {
                console.error("讀取場地資料失敗:", error);
            }
        });
    </script>
}